<!DOCTYPE html>
<!-- 
社内図書館システム - QRコードスキャナーページ

機能概要:
- カメラを使用したリアルタイムQRコード読み取り機能
- jsQRライブラリによる高速・高精度スキャン処理

技術仕様:
- MediaDevices API (カメラアクセス)
- Canvas API (映像処理・QRコード解析)
- jsQR v1.4.0 (QRコード解析ライブラリ)
- Bootstrap 5 (レスポンシブUI)
- Thymeleaf (テンプレートエンジン)

-->
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layout/layout :: layout(~{::title}, ~{::section})}">

<head>
    <!-- ページタイトル設定 -->
    <title>QRコードスキャナー</title>
</head>

<body>
<!-- メインコンテンツセクション -->
<section class="container-fluid py-4">
    
    <!-- Bootstrap Icons（アイコン表示用） -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

    <div class="row justify-content-center">
        <div class="col-12">
            
            <!-- メインカードコンテナ -->
            <div class="card shadow-lg border-0">
                
                <!-- カードヘッダー（緑色背景でアイコン付き） -->
                <div class="card-header bg-success text-white text-center py-3">
                    <h2 class="mb-0">
                        <i class="bi bi-qr-code-scan me-2"></i>
                        QRコードスキャナー
                    </h2>
                    <p class="mb-0 mt-2 opacity-75">カメラでQRコードを読み取ります</p>
                </div>
                
                <!-- カードボディ（メインコンテンツエリア） -->
                <div class="card-body p-4">
                    
                    <!-- カメラ映像表示エリア -->
                    <div class="text-center mb-4">
                        <!-- メインビデオコンテナ（固定サイズの枠） -->
                        <div id="video-container" class="position-relative mx-auto rounded border border-success border-3 shadow-sm bg-light" style="width: 100%; max-width: 500px; height: 300px; overflow: hidden;">
                            
                            <!-- モバイルサイズ固定用のスタイル -->
                            <style>
                                #video-container {
                                    max-width: 100% !important;
                                    height: 250px !important;
                                }
                            </style>
                            
                            <!-- ビデオ要素（カメラ映像表示、初期状態は非表示） -->
                            <video id="qr-video" 
                                   class="position-absolute top-0 start-0 w-100 h-100"
                                   style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; background-color: black; z-index: 1;"
                                   playsinline
                                   muted
                                   autoplay>
                            </video>
                            
                            <!-- スキャンガイド表示（ビデオが非表示の時に表示） -->
                            <div id="scan-guide" class="position-absolute top-0 start-0 w-100 h-100 d-flex flex-column justify-content-center align-items-center bg-light">
                                <i class="bi bi-camera-video text-muted display-1"></i>
                                <p class="text-muted mt-3 mb-0 text-center small">
                                    「スキャン開始」ボタンを押して<br>
                                    QRコードをカメラに向けてください
                                </p>
                            </div>
                            
                            <!-- スキャンオーバーレイ（QRコード検出エリアの表示） -->
                            <div id="scan-overlay" class="position-absolute top-50 start-50 translate-middle" style="display: none; z-index: 2;">
                                <div class="border border-warning border-3 bg-transparent" style="width: 200px; height: 200px; border-style: dashed !important;">
                                </div>
                            </div>
                        </div>
                        
                        <!-- キャンバス要素（QRコード解析用、非表示） -->
                        <canvas id="qr-canvas" style="display: none;"></canvas>
                    </div>
                    

                    
                    <!-- エラー表示エリア（初期状態は非表示） -->
                    <div id="error-message" class="alert alert-danger border-0 shadow-sm rounded-3" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill text-danger me-3 fs-2"></i>
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold">エラーが発生しました</h6>
                                <div id="error-text"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 操作ボタンセクション -->
                    <div class="text-center mb-4">
                        <!-- スキャン開始ボタン（青色、全幅） -->
                        <button id="start-scan-btn" class="btn btn-primary btn-lg w-100 mb-3" type="button" onclick="startScanning();">
                            <i class="bi bi-camera me-2"></i>
                            スキャン開始
                        </button>
                        
                        <!-- スキャン停止ボタン（赤色、全幅、初期状態は無効） -->
                        <button id="stop-scan-btn" class="btn btn-danger btn-lg w-100" type="button" disabled onclick="stopScanning();">
                            <i class="bi bi-stop-circle me-2"></i>
                            スキャン停止
                        </button>
                    </div>
                    
                    <!-- 使用方法の説明 -->
                    <div class="mt-4">
                        <div class="card bg-light border-0 rounded-3">
                            <div class="card-body p-3">
                                <h6 class="card-title text-muted mb-2">
                                    <i class="bi bi-info-circle me-2"></i>
                                    使用方法
                                </h6>
                                <ul class="list-unstyled mb-0 small text-muted">
                                    <li class="mb-1">
                                        <i class="bi bi-1-circle me-2"></i>
                                        「スキャン開始」ボタンをタップします
                                    </li>
                                    <li class="mb-1">
                                        <i class="bi bi-2-circle me-2"></i>
                                        カメラの使用許可を求められた場合は「許可」を選択します
                                    </li>
                                    <li class="mb-1">
                                        <i class="bi bi-3-circle me-2"></i>
                                        QRコードをカメラの中央に映します
                                    </li>
                                    <li>
                                        <i class="bi bi-4-circle me-2"></i>
                                        自動的に読み取り結果が表示されます
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- 戻るボタン -->
                    <div class="col-12 border-0 mt-3">
                        <a href="/page/top" class="text-black ms-2">
                            TOPに戻る
                            <i class="bi bi-arrow-return-left ms-1"></i>
                        </a>
                    </div>

                </div>
            </div>
        </div>
    </div>



    <!-- jsQRライブラリ（QRコード解析用） -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <!-- メインのJavaScript処理 -->
    <script>
        // グローバル変数
        let video, canvas, context, scanning = false, stream = null;
        
        // DOM読み込み完了後の初期化
        document.addEventListener('DOMContentLoaded', function() {
            // 1秒後に初期化を実行（要素の確実な読み込みを待つ）
            setTimeout(function() {
                // 要素の初期化
                initializeElements();
                
                // イベントリスナーの設定
                setupEventListeners();
                
                // カメラ対応チェック
                checkCameraSupport();
            }, 1000);
        });
        
        function initializeElements() {
            video = document.getElementById('qr-video');
            canvas = document.getElementById('qr-canvas');
            
            if (canvas) {
                context = canvas.getContext('2d');
            }
        }
        
        function setupEventListeners() {
            const startBtn = document.getElementById('start-scan-btn');
            const stopBtn = document.getElementById('stop-scan-btn');
            
            if (startBtn) {
                startBtn.addEventListener('click', function() {
                    startScanning();
                });
            }
            
            if (stopBtn) {
                stopBtn.addEventListener('click', function() {
                    stopScanning();
                });
            }
            

        }
        

        
        function checkCameraSupport() {
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                showError('このブラウザはカメラ機能をサポートしていません');
                return false;
            }
            
            if (typeof jsQR === 'undefined') {
                showError('jsQRライブラリが読み込まれていません');
                return false;
            }
            
            return true;
        }
        
        async function startScanning() {
            try {
                if (scanning) {
                    return;
                }
                
                hideError();
                
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 }
                    }
                };
                
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                video.srcObject = stream;
                
                // ガイドを非表示にしてビデオを表示
                document.getElementById('scan-guide').style.display = 'none';
                video.style.display = 'block';
                
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play().then(() => {
                            resolve();
                        }).catch((err) => {
                            console.error('ビデオ再生エラー:', err);
                            resolve(); // エラーでも続行
                        });
                    };
                    
                    // タイムアウト処理
                    setTimeout(() => {
                        resolve();
                    }, 3000);
                });
                
                // オーバーレイを表示
                document.getElementById('scan-overlay').style.display = 'block';
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                scanning = true;
                updateButtonStates(true);
                
                requestAnimationFrame(scanLoop);
                
            } catch (error) {
                console.error('カメラ開始エラー:', error);
                
                let errorMessage = 'カメラの開始に失敗しました';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'カメラの使用が許可されていません。ブラウザの設定を確認してください';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'カメラが見つかりません';
                } else if (error.name === 'NotReadableError') {
                    errorMessage = 'カメラが他のアプリケーションで使用中です';
                }
                
                showError(errorMessage);
            }
        }
        
        function stopScanning() {
            scanning = false;
            
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            if (video) {
                video.srcObject = null;
                video.style.display = 'none';
            }
            
            // 表示を元に戻す：ガイドを表示、オーバーレイを非表示
            document.getElementById('scan-guide').style.display = 'flex';
            document.getElementById('scan-overlay').style.display = 'none';
            
            updateButtonStates(false);
            hideError();
        }
        
        function scanLoop() {
            if (!scanning) {
                return;
            }
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const qrCode = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (qrCode) {
                    // QRコード読み取り成功時の処理
                    stopScanning();
                    
                    // フォーム送信によるダミーページへの遷移
                    // セッション維持を確実にするためwindow.location.hrefではなくフォーム送信を使用
                    const form = document.createElement('form');
                    form.method = 'GET';
                    form.action = '/page/dummy';
                    
                    // QRデータをhiddenパラメータとして設定
                    const input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = 'qrData';
                    input.value = qrCode.data;
                    form.appendChild(input);
                    
                    // フォームを送信してページ遷移
                    document.body.appendChild(form);
                    form.submit();
                    
                    return;
                }
            }
            
            requestAnimationFrame(scanLoop);
        }
        
        function updateButtonStates(isScanning) {
            const startBtn = document.getElementById('start-scan-btn');
            const stopBtn = document.getElementById('stop-scan-btn');
            
            if (startBtn) {
                startBtn.disabled = isScanning;
                if (isScanning) {
                    startBtn.innerHTML = '<i class="bi bi-camera me-2"></i>スキャン中...';
                } else {
                    startBtn.innerHTML = '<i class="bi bi-camera me-2"></i>スキャン開始';
                }
            }
            
            if (stopBtn) {
                stopBtn.disabled = !isScanning;
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            
            if (errorDiv && errorText) {
                errorText.textContent = message;
                errorDiv.style.display = 'block';
            }
        }
        
        function hideError() {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                errorDiv.style.display = 'none';
            }
        }
        

        
        // ページを離れる際のクリーンアップ
        window.addEventListener('beforeunload', function() {
            stopScanning();
        });
        
        // ページが非表示になった際の処理
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && scanning) {
                stopScanning();
            }
        });
        
        // 関数をグローバルスコープで定義（onclickから呼び出せるように）
        window.startScanning = startScanning;
        window.stopScanning = stopScanning;
    </script>
</section>
</body>
</html> 